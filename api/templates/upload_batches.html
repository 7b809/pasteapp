<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Batch Text Uploader</title>
<!-- Bootstrap CSS CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container py-5">
  <h1 class="text-center mb-4">Batch Text Uploader</h1>

  <div class="card p-4 shadow-sm">
    <div class="mb-3">
      <label class="form-label"><b>Select Text File (.txt):</b></label>
      <input class="form-control" type="file" id="fileInput" accept=".txt">
    </div>
    <button id="uploadBtn" class="btn btn-primary mb-3" disabled>Upload in Batches</button>
    <div id="status" class="mb-3 fw-bold"></div>

    <ul id="idList" class="list-group mb-3"></ul>
    <button id="copyBtn" class="btn btn-success" style="display:none;">Copy All IDs</button>
  </div>
</div>

<!-- Bootstrap JS Bundle CDN -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const statusDiv = document.getElementById('status');
const idList = document.getElementById('idList');
const copyBtn = document.getElementById('copyBtn');

let textContent = '';

fileInput.addEventListener('change', () => {
  const file = fileInput.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    textContent = e.target.result;
    statusDiv.textContent = `File loaded (${textContent.length} chars). Ready to upload.`;
    uploadBtn.disabled = false;
  };
  reader.readAsText(file);
});

uploadBtn.addEventListener('click', async () => {
  if(!textContent) return alert('Please select a file first.');
  uploadBtn.disabled = true;
  idList.innerHTML = '';
  copyBtn.style.display = 'none';

  const CHUNK = 80000;
  const total = Math.ceil(textContent.length / CHUNK);
  const ids = [];

  for(let i=0; i<total; i++) {
    const chunk = textContent.slice(i*CHUNK, (i+1)*CHUNK);
    statusDiv.textContent = `Uploading batch ${i+1} of ${total}...`;

    try {
      const res = await fetch('/api/upload/raw', {
        method: 'POST',
        headers: {'Content-Type':'text/plain'},
        body: chunk
      });
      const data = await res.json();

      const li = document.createElement('li');
      li.classList.add('list-group-item');

      if(data.status === 'success'){
        ids.push(data.key);
        li.innerHTML = `<a href="/${data.key}" target="_blank">${data.key}</a>`;
      } else {
        li.textContent = `Error in batch ${i+1}: ${data.message}`;
        li.classList.add('list-group-item-danger');
      }
      idList.appendChild(li);

    } catch(err) {
      const li = document.createElement('li');
      li.textContent = `Error in batch ${i+1}: ${err.message}`;
      li.classList.add('list-group-item-danger');
      idList.appendChild(li);
    }
  }

  statusDiv.textContent = `Upload complete! ${ids.length} of ${total} batches uploaded.`;
  copyBtn.style.display = 'inline-block';

  copyBtn.onclick = () => {
    navigator.clipboard.writeText(ids.join('\n'));
    copyBtn.textContent = 'Copied!';
    setTimeout(() => copyBtn.textContent = 'Copy All IDs', 1500);
  };
});
</script>
</body>
</html>
